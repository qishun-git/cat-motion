{% extends "base.html" %}

{% block title %}Training Â· Cat Motion{% endblock %}

{% block content %}
<section>
  <h2>Training Images</h2>
  {% if training_entries %}
  {% for label, images in training_entries.items() %}
  <div class="training-group">
    <header>
      <h3>{{ label }}</h3>
      <small>{{ images|length }} image(s)</small>
    </header>
    <div class="training-grid">
      {% for image in images %}
      <figure data-label="{{ label }}" data-image="{{ image }}">
        <img src="/training/{{ label | urlencode }}/{{ image | urlencode }}" alt="{{ label }}" />
        <figcaption>{{ image }}</figcaption>
        <form class="assign-training-form">
          <input type="hidden" name="current_label" value="{{ label }}" />
          <input type="text" name="new_label" value="{{ label }}" />
          <button type="submit" class="secondary">Save</button>
        </form>
        <button type="button" class="delete-training danger">Delete</button>
      </figure>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p>No training images yet.</p>
  {% endif %}
</section>

<script>
  document.querySelectorAll(".delete-training").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this training image?")) {
        return;
      }
      const figure = btn.closest("figure");
      const payload = {
        label: figure.dataset.label,
        image: figure.dataset.image,
      };
      btn.disabled = true;
      try {
        const res = await fetch("/api/training/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        figure.remove();
      } catch (err) {
        alert("Failed to delete image.");
        btn.disabled = false;
      }
    });
  });

  document.querySelectorAll(".assign-training-form").forEach((form) => {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const figure = form.closest("figure");
      const payload = {
        current_label: figure.dataset.label,
        image: figure.dataset.image,
        new_label: form.querySelector("input[name='new_label']").value.trim(),
      };
      if (!payload.new_label) {
        alert("Label is required.");
        return;
      }
      form.querySelector("button").disabled = true;
      try {
        const res = await fetch("/api/training/assign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        location.reload();
      } catch (err) {
        alert("Failed to update label.");
        form.querySelector("button").disabled = false;
      }
    });
  });
</script>
{% endblock %}
