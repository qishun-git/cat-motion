{% extends "base.html" %}

{% block title %}Training · Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Training</p>
    <h1>Curate your dataset</h1>
    <p class="muted">Adjust labels, clean noisy captures, and keep embeddings fresh.</p>
  </div>
  <div>
    <span class="chip">{{ training_entries | length }} label group(s)</span>
    <div class="hero-actions" style="margin-top: 0.5rem">
      <button type="button" class="btn btn-primary" id="train-btn">Train embeddings</button>
      <small class="muted" id="train-status"></small>
    </div>
  </div>
</section>

{% if training_entries %}
  {% for label, images in training_entries.items() %}
  <section class="card" data-label="{{ label }}">
    <div class="section-header">
      <div>
        <p class="eyebrow">Label</p>
        <h2>{{ label }}</h2>
      </div>
      <span class="badge">{{ images | length }} image(s)</span>
    </div>
    <div class="gallery-toolbar" data-label="{{ label }}">
      <div class="form-row">
        <button type="button" class="btn btn-danger bulk-delete">Delete selected</button>
        <button type="button" class="btn btn-ghost select-all">Select all</button>
        <button type="button" class="btn btn-secondary clear-selection">Clear</button>
      </div>
      <small class="selection-count muted">0 selected</small>
    </div>
    <div class="gallery-grid">
      {% for image in images %}
      <figure class="media-card" data-label="{{ label }}" data-image="{{ image }}">
        <label class="select-checkbox">
          <input type="checkbox" class="select-image" />
          <span></span>
        </label>
        <div class="media-frame media-frame--preview">
          <img src="/training/{{ label | urlencode }}/{{ image | urlencode }}" alt="{{ label }}" />
        </div>
        <figcaption>{{ image }}</figcaption>
        <form class="form-row assign-training-form">
          <input type="hidden" name="current_label" value="{{ label }}" />
          <input type="text" name="new_label" value="{{ label }}" />
          <button type="submit" class="btn btn-secondary">Save</button>
        </form>
        <button type="button" class="btn btn-danger delete-training">Delete</button>
      </figure>
      {% endfor %}
    </div>
  </section>
  {% endfor %}
{% else %}
<section class="card">
  <p class="card-empty">No training images yet.</p>
</section>
{% endif %}

<script>
  const removeCardIfEmpty = (figure) => {
    const section = figure.closest("section.card");
    if (!section) return;
    if (section.querySelectorAll("figure").length === 0) {
      section.remove();
    }
  };

  document.querySelectorAll(".gallery-toolbar[data-label]").forEach((toolbar) => {
    const section = toolbar.closest("section.card");
    const label = toolbar.dataset.label;
    const bulkDeleteBtn = toolbar.querySelector(".bulk-delete");
    const selectAllBtn = toolbar.querySelector(".select-all");
    const clearBtn = toolbar.querySelector(".clear-selection");
    const countEl = toolbar.querySelector(".selection-count");

    const getCheckboxes = () => Array.from(section.querySelectorAll(".select-image"));

    const updateCount = () => {
      const selectedCount = getCheckboxes().filter((c) => c.checked).length;
      countEl.textContent = `${selectedCount} selected`;
      bulkDeleteBtn.disabled = selectedCount === 0;
    };

    getCheckboxes().forEach((checkbox) => {
      checkbox.addEventListener("change", updateCount);
    });

    selectAllBtn?.addEventListener("click", () => {
      getCheckboxes().forEach((checkbox) => {
        checkbox.checked = true;
      });
      updateCount();
    });

    clearBtn.addEventListener("click", () => {
      getCheckboxes().forEach((checkbox) => {
        checkbox.checked = false;
      });
      updateCount();
    });

    section.querySelectorAll(".delete-training").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const figure = btn.closest("figure");
        const payload = {
          label: figure.dataset.label,
          image: figure.dataset.image,
        };
        btn.disabled = true;
        try {
          const res = await fetch("/api/training/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("failed");
          figure.remove();
          removeCardIfEmpty(figure);
        } catch (err) {
          alert("Failed to delete image.");
          btn.disabled = false;
          return;
        }
        updateCount();
      });
    });

    bulkDeleteBtn.addEventListener("click", async () => {
      const selectedImages = getCheckboxes()
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.closest("figure").dataset.image);
      if (!selectedImages.length) {
        alert("Select at least one image.");
        return;
      }
      bulkDeleteBtn.disabled = true;
      try {
        const res = await fetch(`/api/training/${encodeURIComponent(label)}/bulk-delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ images: selectedImages }),
        });
        if (!res.ok) throw new Error("failed");
        selectedImages.forEach((image) => {
          const figure = Array.from(section.querySelectorAll("figure")).find((fig) => fig.dataset.image === image);
          if (figure) {
            figure.remove();
            removeCardIfEmpty(figure);
          }
        });
      } catch (err) {
        alert("Failed to delete images.");
      } finally {
        bulkDeleteBtn.disabled = false;
        updateCount();
      }
    });

    updateCount();
  });

  document.querySelectorAll(".assign-training-form").forEach((form) => {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const figure = form.closest("figure");
      const payload = {
        current_label: figure.dataset.label,
        image: figure.dataset.image,
        new_label: form.querySelector("input[name='new_label']").value.trim(),
      };
      if (!payload.new_label) {
        alert("Label is required.");
        return;
      }
      form.querySelector("button").disabled = true;
      try {
        const res = await fetch("/api/training/assign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        location.reload();
      } catch (err) {
        alert("Failed to update label.");
        form.querySelector("button").disabled = false;
      }
    });
  });

  const trainBtn = document.getElementById("train-btn");
  const trainStatus = document.getElementById("train-status");
  if (trainBtn) {
    trainBtn.addEventListener("click", async () => {
      trainBtn.disabled = true;
      trainStatus.textContent = "Training…";
      try {
        const res = await fetch("/api/train", { method: "POST" });
        if (!res.ok) throw new Error("failed");
        trainStatus.textContent = "Embeddings updated.";
      } catch (err) {
        trainStatus.textContent = "Training failed.";
      } finally {
        trainBtn.disabled = false;
      }
    });
  }
</script>
{% endblock %}
