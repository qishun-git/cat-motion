{% extends "base.html" %}

{% block title %}Clips · Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Clips</p>
    <h1>Review processed footage</h1>
    <p class="muted">Use the paginated browser below to keep load times fast.</p>
  </div>
  <span class="chip warn">Recognized page {{ recognized.page }} · Unknown page {{ unknown.page }}</span>
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Library</p>
      <h2>Recognized clips</h2>
      <p class="muted">Matched against embeddings. Page through to revisit older captures.</p>
    </div>
  </div>
  {% if recognized.entries %}
  <div class="clip-grid">
    {% for clip in recognized.entries %}
    <article class="clip-card" data-category="recognized" data-clip="{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Label</p>
          <h3>{{ clip.summary.highlight_label or "Unknown" }}</h3>
        </div>
        <div class="clip-meta-actions">
          <span class="badge">{{ clip.size_mb }} MB</span>
          <button type="button" class="btn btn-danger delete-clip">Delete</button>
        </div>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" src="/clips/recognized/{{ clip.path }}"></video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      {% set recognized_total = clip.summary.get("recognized_total", clip.summary.get("recognized", 0)) %}
      <div class="clip-stats">
        <span class="chip">{{ detections }} detections</span>
        <span class="chip good">{{ recognized_total }} recognized</span>
      </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
  <div class="pager">
    {% if recognized.has_prev %}
    <a class="btn btn-ghost" href="{{ recognized.prev_url or '#' }}">← Previous</a>
    {% endif %}
    <span>Page {{ recognized.page }}</span>
    {% if recognized.has_next %}
    <a class="btn btn-ghost" href="{{ recognized.next_url or '#' }}">Next →</a>
    {% endif %}
  </div>
  {% else %}
  <p class="card-empty">No recognized clips yet.</p>
  {% endif %}
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Needs attention</p>
      <h2>Unknown clips</h2>
      <p class="muted">Unknown clips are retried on the next processing run. Delete to drop noise.</p>
    </div>
  </div>
  {% if unknown.entries %}
  <div class="clip-grid">
    {% for clip in unknown.entries %}
    <article class="clip-card" data-category="unknown" data-clip="{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Detected</p>
          <h3>Unknown</h3>
        </div>
        <div class="clip-meta-actions">
          <span class="badge">{{ clip.size_mb }} MB</span>
          <button type="button" class="btn btn-danger delete-clip">Delete</button>
        </div>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" src="/clips/unknown/{{ clip.path }}"></video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      <div class="clip-stats">
        <span class="chip warn">{{ detections }} detection(s)</span>
      </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
  <div class="pager">
    {% if unknown.has_prev %}
    <a class="btn btn-ghost" href="{{ unknown.prev_url or '#' }}">← Previous</a>
    {% endif %}
    <span>Page {{ unknown.page }}</span>
    {% if unknown.has_next %}
    <a class="btn btn-ghost" href="{{ unknown.next_url or '#' }}">Next →</a>
    {% endif %}
  </div>
  {% else %}
  <p class="card-empty">No pending clips.</p>
  {% endif %}
</section>

<script>
  document.querySelectorAll(".delete-clip").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this clip?")) return;
      const article = btn.closest("article");
      const payload = {
        category: article.dataset.category,
        clip: article.dataset.clip,
      };
      btn.disabled = true;
      try {
        const res = await fetch("/api/clips/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        article.remove();
      } catch (err) {
        alert("Failed to delete clip.");
        btn.disabled = false;
      }
    });
  });
</script>
{% endblock %}
