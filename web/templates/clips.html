{% extends "base.html" %}

{% block title %}Clips · Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Clips</p>
    <h1>Review processed footage</h1>
    <p class="muted">Pick a label or the Unknown bucket to load only the clips you need.</p>
  </div>
  <span class="chip warn">{{ recognized_labels | length }} label(s)</span>
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Library</p>
      <h2>Recognized labels</h2>
      <p class="muted">Choose a label below or open the Unknown bucket.</p>
    </div>
  </div>
  {% if recognized_labels %}
  <div class="bucket-list">
    {% for entry in recognized_labels %}
    <a
      class="bucket-row {% if selected_label == entry.name %}is-active{% endif %}"
      href="{{ request.url.include_query_params(label=entry.name, category=None, page=1) }}"
    >
      <span>{{ entry.name }}</span>
      <span class="badge">{{ entry.count }} clip(s)</span>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <p class="card-empty">No recognized clips yet.</p>
  {% endif %}
  <div class="bucket-list" style="margin-top: 1.5rem">
    <a
      class="bucket-row {% if show_unknown %}is-active{% endif %}"
      href="{{ request.url.include_query_params(category='unknown', label=None, page=1) }}"
    >
      <span>Unknown bucket</span>
      <span class="badge">{{ unknown_count }} clip(s)</span>
    </a>
  </div>
</section>

{% if selected_label %}
<section class="card" data-category="recognized">
  <div class="section-header">
    <div>
      <p class="eyebrow">Label</p>
      <h2>{{ selected_label }}</h2>
      <p class="muted">Only clips classified as {{ selected_label }} are shown.</p>
    </div>
  </div>
  {% if clips %}
  <div class="clip-grid">
    {% for clip in clips %}
    <article class="clip-card" data-category="recognized" data-clip="{{ selected_label }}/{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Label</p>
          <h3>{{ selected_label }}</h3>
        </div>
        <div class="clip-meta-actions">
          <span class="badge">{{ clip.size_mb }} MB</span>
          <button type="button" class="btn btn-danger delete-clip">Delete</button>
        </div>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" playsinline>
          <source src="/clips/recognized/{{ selected_label | urlencode }}/{{ clip.path }}" type="video/mp4" />
          Your browser does not support MP4 playback.
        </video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      {% set recognized_total = clip.summary.get("recognized_total", clip.summary.get("recognized", 0)) %}
      <div class="clip-stats">
        <span class="chip">{{ detections }} detections</span>
        <span class="chip good">{{ recognized_total }} recognized</span>
      </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
  <div class="pager">
    {% if pagination.has_prev %}
    <a class="btn btn-ghost" href="{{ pagination.prev_url or '#' }}">← Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }}</span>
    {% if pagination.has_next %}
    <a class="btn btn-ghost" href="{{ pagination.next_url or '#' }}">Next →</a>
    {% endif %}
  </div>
  {% else %}
  <p class="card-empty">No clips for this label.</p>
  {% endif %}
</section>
{% elif show_unknown %}
<section class="card" data-category="unknown">
  <div class="section-header">
    <div>
      <p class="eyebrow">Bucket</p>
      <h2>Unknown clips</h2>
      <p class="muted">These clips did not match existing embeddings.</p>
    </div>
  </div>
  {% if clips %}
  <div class="clip-grid">
    {% for clip in clips %}
    <article class="clip-card" data-category="unknown" data-clip="{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Detected</p>
          <h3>Unknown</h3>
        </div>
        <div class="clip-meta-actions">
          <span class="badge">{{ clip.size_mb }} MB</span>
          <button type="button" class="btn btn-danger delete-clip">Delete</button>
        </div>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" playsinline>
          <source src="/clips/unknown/{{ clip.path }}" type="video/mp4" />
          Your browser does not support MP4 playback.
        </video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      <div class="clip-stats">
        <span class="chip warn">{{ detections }} detection(s)</span>
      </div>
      {% endif %}
    </article>
    {% endfor %}
  </div>
  <div class="pager">
    {% if pagination.has_prev %}
    <a class="btn btn-ghost" href="{{ pagination.prev_url or '#' }}">← Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }}</span>
    {% if pagination.has_next %}
    <a class="btn btn-ghost" href="{{ pagination.next_url or '#' }}">Next →</a>
    {% endif %}
  </div>
  {% else %}
  <p class="card-empty">No unknown clips.</p>
  {% endif %}
</section>
{% else %}
<section class="card">
  <p class="card-empty">Select a label or the Unknown bucket to load clips.</p>
</section>
{% endif %}

<script>
  document.querySelectorAll(".delete-clip").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this clip?")) return;
      const article = btn.closest("article");
      const payload = {
        category: article.dataset.category,
        clip: article.dataset.clip,
      };
      btn.disabled = true;
      try {
        const res = await fetch("/api/clips/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        article.remove();
      } catch (err) {
        alert("Failed to delete clip.");
        btn.disabled = false;
      }
    });
  });
</script>
{% endblock %}
