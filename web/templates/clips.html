{% extends "base.html" %}

{% block title %}Clips Â· Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Clips</p>
    <h1>Review processed footage</h1>
    <p class="muted">Label unknown segments, tidy up recognized ones, and keep storage lean.</p>
  </div>
  <span class="chip warn">{{ recognized | length + unknown | length }} clip(s) loaded</span>
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Library</p>
      <h2>Recognized clips</h2>
      <p class="muted">Matched against embeddings. Tweak labels or archive them.</p>
    </div>
    <span class="badge">{{ recognized | length }}</span>
  </div>
  {% if recognized %}
  <div class="clip-grid">
    {% for clip in recognized %}
    <article class="clip-card" data-category="recognized" data-clip="{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Label</p>
          <h3>{{ clip.summary.highlight_label or "Unknown" }}</h3>
        </div>
        <span class="badge">{{ clip.size_mb }} MB</span>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" src="/clips/recognized/{{ clip.path }}"></video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      {% set recognized_total = clip.summary.get("recognized_total", clip.summary.get("recognized", 0)) %}
      <div class="clip-stats">
        <span class="chip">{{ detections }} detections</span>
        <span class="chip good">{{ recognized_total }} recognized</span>
      </div>
      {% endif %}
      <div class="card-actions">
        <a href="/clips/recognized/{{ clip.path }}" target="_blank" class="btn btn-ghost">View clip</a>
        <button type="button" class="btn btn-danger delete-clip">Delete</button>
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <p class="card-empty">No recognized clips yet.</p>
  {% endif %}
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Needs attention</p>
      <h2>Unknown clips</h2>
      <p class="muted">Label anything the recognizer could not match.</p>
    </div>
    <span class="badge">{{ unknown | length }}</span>
  </div>
  <p class="muted">Unknown clips are retried during the next processing run. You can delete noisy captures below.</p>
  {% if unknown %}
  <div class="clip-grid">
    {% for clip in unknown %}
    <article class="clip-card" data-category="unknown" data-clip="{{ clip.path }}">
      <div class="clip-meta">
        <div>
          <p class="eyebrow">Detected</p>
          <h3>Unknown</h3>
        </div>
        <span class="badge">{{ clip.size_mb }} MB</span>
      </div>
      <div class="media-frame">
        <video controls preload="metadata" src="/clips/unknown/{{ clip.path }}"></video>
      </div>
      {% if clip.summary %}
      {% set detections = clip.summary.get("detections_total", clip.summary.get("detections", 0)) %}
      <div class="clip-stats">
        <span class="chip warn">{{ detections }} detection(s)</span>
      </div>
      {% endif %}
      <div class="card-actions">
        <a href="/clips/unknown/{{ clip.path }}" target="_blank" class="btn btn-ghost">View clip</a>
        <button type="button" class="btn btn-danger delete-clip">Delete</button>
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <p class="card-empty">No pending clips.</p>
  {% endif %}
</section>

<script>
  document.querySelectorAll(".delete-clip").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this clip?")) return;
      const article = btn.closest("article");
      const payload = {
        category: article.dataset.category,
        clip: article.dataset.clip,
      };
      btn.disabled = true;
      try {
        const res = await fetch("/api/clips/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        article.remove();
      } catch (err) {
        alert("Failed to delete clip.");
        btn.disabled = false;
      }
    });
  });
</script>
{% endblock %}
