{% extends "base.html" %}

{% block title %}Unlabeled · Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Unlabeled</p>
    <h1>Triage captured frames</h1>
  </div>
  <span class="chip warn">{{ buckets | length }} bucket(s)</span>
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Buckets</p>
      <h2>Motion exports</h2>
    </div>
  </div>
  {% if buckets %}
  <div class="bucket-list">
    {% for bucket in buckets %}
    <a class="bucket-row" href="{{ request.url.include_query_params(folder=bucket.name, page=1) }}">
      <span>{{ bucket.name }}</span>
      <span class="badge">{{ bucket.count }} image(s)</span>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <p class="card-empty">No buckets available.</p>
  {% endif %}
</section>

{% if selected_folder %}
<section class="card" data-folder="{{ selected_folder }}">
  <div class="section-header">
    <div>
      <p class="eyebrow">Bucket</p>
      <h2>{{ selected_folder }}</h2>
    </div>
    <span class="badge">{{ selected_images | length }} image(s)</span>
  </div>
  {% if selected_images %}
  <div class="gallery-toolbar" data-folder="{{ selected_folder }}">
    <div class="form-row">
      <input type="text" list="known-labels" class="bulk-label-input" placeholder="Label name" />
      <button type="button" class="btn btn-primary bulk-assign">Assign selected</button>
      <button type="button" class="btn btn-danger bulk-delete">Delete selected</button>
      <button type="button" class="btn btn-ghost select-all">Select all</button>
      <button type="button" class="btn btn-secondary clear-selection">Clear</button>
    </div>
    <small class="selection-count muted">0 selected</small>
  </div>
  <div class="gallery-grid">
    {% for image in selected_images %}
    <figure class="media-card" data-folder="{{ selected_folder }}" data-image="{{ image }}">
      <label class="select-checkbox">
        <input type="checkbox" class="select-image" />
        <span></span>
      </label>
      <div class="media-frame media-frame--preview">
        <img src="/unlabeled/{{ selected_folder | urlencode }}/{{ image | urlencode }}" alt="{{ selected_folder }}" />
      </div>
      <figcaption>{{ image }}</figcaption>
      <button type="button" class="btn btn-danger delete-unlabeled">Delete</button>
    </figure>
    {% endfor %}
  </div>
  <div class="pager">
    {% if pagination.has_prev %}
    <a class="btn btn-ghost" href="{{ pagination.prev_url or '#' }}">← Previous</a>
    {% endif %}
    <span>Page {{ pagination.page }}</span>
    {% if pagination.has_next %}
    <a class="btn btn-ghost" href="{{ pagination.next_url or '#' }}">Next →</a>
    {% endif %}
  </div>
  {% else %}
  <p class="card-empty">Bucket is empty.</p>
  {% endif %}
</section>
{% else %}
<section class="card">
  <p class="card-empty">Select a bucket to begin.</p>
</section>
{% endif %}

<datalist id="known-labels">
  {% for label in known_labels %}
  <option value="{{ label }}"></option>
  {% endfor %}
</datalist>

<script>
  const removeCardIfEmpty = (figure) => {
    const section = figure.closest("section.card");
    if (!section) return;
    if (section.querySelectorAll("figure").length === 0) {
      section.remove();
    }
  };

  document.querySelectorAll(".gallery-toolbar[data-folder]").forEach((toolbar) => {
    const section = toolbar.closest("section");
    const folder = toolbar.dataset.folder;
    const labelInput = toolbar.querySelector(".bulk-label-input");
    const assignBtn = toolbar.querySelector(".bulk-assign");
    const bulkDeleteBtn = toolbar.querySelector(".bulk-delete");
    const clearBtn = toolbar.querySelector(".clear-selection");
    const selectAllBtn = toolbar.querySelector(".select-all");
    const countEl = toolbar.querySelector(".selection-count");

    const getCheckboxes = () => Array.from(section.querySelectorAll(".select-image"));

    const updateCount = () => {
      const selectedCount = getCheckboxes().filter((c) => c.checked).length;
      countEl.textContent = `${selectedCount} selected`;
      assignBtn.disabled = selectedCount === 0;
      bulkDeleteBtn.disabled = selectedCount === 0;
    };

    getCheckboxes().forEach((checkbox) => {
      checkbox.addEventListener("change", updateCount);
    });

    clearBtn.addEventListener("click", () => {
      getCheckboxes().forEach((checkbox) => {
        checkbox.checked = false;
      });
      updateCount();
    });

    selectAllBtn?.addEventListener("click", () => {
      getCheckboxes().forEach((checkbox) => {
        checkbox.checked = true;
      });
      updateCount();
    });

    section.querySelectorAll(".delete-unlabeled").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const figure = btn.closest("figure");
        btn.disabled = true;
        try {
          const res = await fetch(`/api/unlabeled/${folder}/${figure.dataset.image}/delete`, {
            method: "POST",
          });
          if (!res.ok) throw new Error("failed");
          figure.remove();
          removeCardIfEmpty(figure);
        } catch (err) {
          alert("Failed to delete image.");
          btn.disabled = false;
          return;
        }
        updateCount();
      });
    });

    assignBtn.addEventListener("click", async () => {
      const label = labelInput.value.trim();
      if (!label) {
        alert("Enter a label.");
        return;
      }
      const selectedImages = getCheckboxes()
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.closest("figure").dataset.image);
      if (!selectedImages.length) {
        alert("Select at least one image.");
        return;
      }
      assignBtn.disabled = true;
      try {
        const res = await fetch(`/api/unlabeled/${folder}/bulk-assign`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ label, images: selectedImages }),
        });
        if (!res.ok) throw new Error("failed");
        selectedImages.forEach((image) => {
          const figure = Array.from(section.querySelectorAll("figure")).find((fig) => fig.dataset.image === image);
          if (figure) {
            figure.remove();
            removeCardIfEmpty(figure);
          }
        });
        labelInput.value = label;
      } catch (err) {
        alert("Failed to assign images.");
      } finally {
        assignBtn.disabled = false;
        updateCount();
      }
    });

    bulkDeleteBtn.addEventListener("click", async () => {
      const selectedImages = getCheckboxes()
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.closest("figure").dataset.image);
      if (!selectedImages.length) {
        alert("Select at least one image.");
        return;
      }
      bulkDeleteBtn.disabled = true;
      try {
        const res = await fetch(`/api/unlabeled/${folder}/bulk-delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ images: selectedImages }),
        });
        if (!res.ok) throw new Error("failed");
        selectedImages.forEach((image) => {
          const figure = Array.from(section.querySelectorAll("figure")).find((fig) => fig.dataset.image === image);
          if (figure) {
            figure.remove();
            removeCardIfEmpty(figure);
          }
        });
      } catch (err) {
        alert("Failed to delete images.");
      } finally {
        bulkDeleteBtn.disabled = false;
        updateCount();
      }
    });

    updateCount();
  });
</script>
{% endblock %}
