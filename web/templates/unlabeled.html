{% extends "base.html" %}

{% block title %}Unlabeled Â· Cat Motion{% endblock %}

{% block content %}
<section class="page-intro">
  <div>
    <p class="eyebrow">Unlabeled</p>
    <h1>Triage captured frames</h1>
    <p class="muted">Label key frames or drop noise before exporting to training.</p>
  </div>
  <span class="chip warn">{{ unlabeled_entries | length }} bucket(s)</span>
</section>

{% if unlabeled_entries %}
  {% for folder, images in unlabeled_entries.items() %}
  <section class="card">
    <div class="section-header">
      <div>
        <p class="eyebrow">Bucket</p>
        <h2>{{ folder }}</h2>
      </div>
      <span class="badge">{{ images | length }} image(s)</span>
    </div>
    <div class="gallery-grid">
      {% for image in images %}
      <figure class="media-card" data-folder="{{ folder }}" data-image="{{ image }}">
        <div class="media-frame">
          <img src="/unlabeled/{{ folder | urlencode }}/{{ image | urlencode }}" alt="{{ folder }}" />
        </div>
        <figcaption>{{ image }}</figcaption>
        <form class="form-row assign-unlabeled-form">
          <input type="text" name="label" list="known-labels" placeholder="Label name" />
          <button type="submit" class="btn btn-primary">Assign</button>
        </form>
        <button type="button" class="btn btn-danger delete-unlabeled">Delete</button>
      </figure>
      {% endfor %}
    </div>
  </section>
  {% endfor %}
  <datalist id="known-labels">
    {% for label in known_labels %}
    <option value="{{ label }}"></option>
    {% endfor %}
  </datalist>
{% else %}
<section class="card">
  <p class="card-empty">No unlabeled images available.</p>
</section>
{% endif %}

<script>
  document.querySelectorAll(".assign-unlabeled-form").forEach((form) => {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const figure = form.closest("figure");
      const label = form.querySelector("input[name='label']").value.trim();
      if (!label) {
        alert("Enter a label.");
        return;
      }
      const payload = {
        label,
      };
      form.querySelector("button").disabled = true;
      try {
        const res = await fetch(`/api/unlabeled/${figure.dataset.folder}/${figure.dataset.image}/assign`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("failed");
        figure.remove();
      } catch (err) {
        alert("Failed to assign image.");
        form.querySelector("button").disabled = false;
      }
    });
  });

  document.querySelectorAll(".delete-unlabeled").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Delete this image?")) return;
      const figure = btn.closest("figure");
      btn.disabled = true;
      try {
        const res = await fetch(`/api/unlabeled/${figure.dataset.folder}/${figure.dataset.image}/delete`, {
          method: "POST",
        });
        if (!res.ok) throw new Error("failed");
        figure.remove();
      } catch (err) {
        alert("Failed to delete image.");
        btn.disabled = false;
      }
    });
  });
</script>
{% endblock %}
