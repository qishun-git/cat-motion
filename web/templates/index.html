{% extends "base.html" %}

{% block content %}
<section class="stream">
  <div class="stream-header">
    <h2>Live Stream</h2>
    <button type="button" id="process-btn">Process Clips</button>
  </div>
  <img
    id="stream-view"
    data-stream-url="{{ stream_url or '' }}"
    data-stream-port="{{ stream_port or '' }}"
    data-stream-path="{{ stream_path }}"
    alt="Live stream"
  />
  <small id="process-status"></small>
</section>

<section>
  <h2>Summary</h2>
  <div class="summary-grid">
    <article>
      <h3>Recognized Clips</h3>
      <p class="metric">{{ recognized_count }}</p>
      <a href="/clips">Manage Clips</a>
    </article>
    <article>
      <h3>Needs Review</h3>
      <p class="metric">{{ unknown_count }}</p>
      <a href="/clips">Label Clips</a>
    </article>
    <article>
      <h3>Unlabeled Images</h3>
      <p class="metric">{{ unlabeled_count }}</p>
      <a href="/clips">Process Clips</a>
    </article>
    <article>
      <h3>Training Images</h3>
      <p class="metric">{{ training_count }}</p>
      <a href="/training">Review Training Set</a>
    </article>
  </div>
</section>

<script>
  const btn = document.getElementById("process-btn");
  const statusEl = document.getElementById("process-status");
  const streamEl = document.getElementById("stream-view");
  if (streamEl) {
    let src = streamEl.dataset.streamUrl;
    if (!src) {
      const port = streamEl.dataset.streamPort || "8081";
      const path = streamEl.dataset.streamPath || "/?action=stream";
      const host = window.location.hostname;
      const protocol = window.location.protocol.startsWith("http") ? window.location.protocol : "http:";
      src = `${protocol}//${host}${port ? `:${port}` : ""}${path}`;
    }
    streamEl.src = src;
  }
  if (btn) {
    btn.addEventListener("click", async () => {
      btn.disabled = true;
      statusEl.textContent = "Processingâ€¦";
      try {
        const res = await fetch("/api/process", { method: "POST" });
        const data = await res.json();
        statusEl.textContent = `Processed ${data.processed} clip(s). Refresh page to see updates.`;
      } catch (err) {
        statusEl.textContent = "Failed to launch processor.";
      } finally {
        btn.disabled = false;
      }
    });
  }

</script>
{% endblock %}
