{% extends "base.html" %}

{% block content %}
<section class="hero card">
  <div class="hero-content">
    <p class="eyebrow">Live Operations</p>
    <h1>Monitor, review, and train from your Pi</h1>
    <p>Stream directly from Motion, keep tabs on new clips, and keep the dataset tidy from any device.</p>
    <div class="hero-actions">
      <button type="button" class="btn btn-primary" id="process-btn">Process pending clips</button>
      <span class="process-status" id="process-status"></span>
    </div>
  </div>
  <div class="hero-media">
    <div class="media-frame stream-frame">
      <div class="stream-pill">Live stream</div>
      <img
        id="stream-view"
        data-stream-url="{{ stream_url or '' }}"
        data-stream-port="{{ stream_port or '' }}"
        data-stream-path="{{ stream_path }}"
        alt="Live stream"
      />
    </div>
    <small class="muted">The stream URL adjusts automatically to your Pi's address.</small>
  </div>
</section>

<section class="card">
  <div class="section-header">
    <div>
      <p class="eyebrow">Pipeline</p>
      <h2>Capture overview</h2>
    </div>
  </div>
  <div class="status-grid">
    <article class="status-card">
      <div class="stat-value">{{ recognized_count }}</div>
      <div class="stat-label">Recognized clips</div>
      <a href="/clips" class="stat-footer">View library →</a>
    </article>
    <article class="status-card">
      <div class="stat-value">{{ unknown_count }}</div>
      <div class="stat-label">Need labels</div>
      <a href="/clips" class="stat-footer">Label clips →</a>
    </article>
    <article class="status-card">
      <div class="stat-value">{{ unlabeled_count }}</div>
      <div class="stat-label">Unlabeled images</div>
      <a href="/unlabeled" class="stat-footer">Triage frames →</a>
    </article>
    <article class="status-card">
      <div class="stat-value">{{ training_count }}</div>
      <div class="stat-label">Training examples</div>
      <a href="/training" class="stat-footer">Review dataset →</a>
    </article>
  </div>
</section>

<script>
  const btn = document.getElementById("process-btn");
  const statusEl = document.getElementById("process-status");
  const streamEl = document.getElementById("stream-view");
  if (streamEl) {
    let src = streamEl.dataset.streamUrl;
    if (!src) {
      const port = streamEl.dataset.streamPort || "8081";
      const path = streamEl.dataset.streamPath || "/?action=stream";
      const host = window.location.hostname;
      const protocol = window.location.protocol.startsWith("http") ? window.location.protocol : "http:";
      src = `${protocol}//${host}${port ? `:${port}` : ""}${path}`;
    }
    streamEl.src = src;
  }
  if (btn) {
    btn.addEventListener("click", async () => {
      btn.disabled = true;
      statusEl.textContent = "Processing…";
      try {
        const res = await fetch("/api/process", { method: "POST" });
        const data = await res.json();
        statusEl.textContent = `Processed ${data.processed} clip(s). Refresh for latest totals.`;
      } catch (err) {
        statusEl.textContent = "Failed to launch processor.";
      } finally {
        btn.disabled = false;
      }
    });
  }
</script>
{% endblock %}
