{% extends "base.html" %}

{% block content %}
<section class="stream">
  <div class="stream-header">
    <h2>Live Stream</h2>
    <button type="button" id="process-btn">Process Clips</button>
  </div>
  <img src="{{ stream_url }}" alt="Live stream" />
  <small id="process-status"></small>
</section>

<section>
  <h2>Recognized Clips</h2>
  <div class="clip-list">
    {% for clip in recognized %}
    <article>
      <h3>{{ clip.summary.label if clip.summary else "Unknown" }}</h3>
      <p>{{ clip.path }}</p>
      <small>{{ clip.size_mb }} MB</small>
    </article>
    {% else %}
    <p>No recognized clips yet.</p>
    {% endfor %}
  </div>
</section>

<section>
  <h2>Needs Review</h2>
  <div class="clip-list">
    {% for clip in unknown %}
    <article>
      <h3>Pending</h3>
      <p>{{ clip.path }}</p>
      <small>{{ clip.size_mb }} MB</small>
    </article>
    {% else %}
    <p>No pending clips! ðŸŽ‰</p>
    {% endfor %}
  </div>
</section>

<section>
  <h2>Unlabeled Buckets</h2>
  <small id="unlabeled-status"></small>
  <div class="clip-list unlabeled">
    {% for folder in unlabeled %}
    <article data-folder="{{ folder.name }}">
      <h3>{{ folder.name }}</h3>
      <p>{{ folder.count }} items</p>
      <form class="assign-form">
        <input name="label" type="text" list="known-labels" placeholder="Label name" autocomplete="off" />
        <button type="submit">Assign</button>
        <button type="button" class="delete-btn">Delete</button>
      </form>
    </article>
    {% else %}
    <p>No unlabeled captures.</p>
    {% endfor %}
  </div>
  <datalist id="known-labels">
    {% for label in known_labels %}
    <option value="{{ label }}"></option>
    {% endfor %}
  </datalist>
</section>

<script>
  const btn = document.getElementById("process-btn");
  const statusEl = document.getElementById("process-status");
  if (btn) {
    btn.addEventListener("click", async () => {
      btn.disabled = true;
      statusEl.textContent = "Processingâ€¦";
      try {
        const res = await fetch("/api/process", { method: "POST" });
        const data = await res.json();
        statusEl.textContent = `Processed ${data.processed} clip(s). Refresh page to see updates.`;
      } catch (err) {
        statusEl.textContent = "Failed to launch processor.";
      } finally {
        btn.disabled = false;
      }
    });
  }

  const unlabeledStatus = document.getElementById("unlabeled-status");
  document.querySelectorAll(".assign-form").forEach((form) => {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const article = form.closest("article");
      const folder = article.dataset.folder;
      const labelInput = form.querySelector("input[name='label']");
      const label = labelInput.value.trim();
      if (!label) {
        unlabeledStatus.textContent = "Enter a label before assigning.";
        return;
      }
      form.querySelectorAll("button").forEach((btn) => (btn.disabled = true));
      try {
        const res = await fetch(`/api/unlabeled/${folder}/assign`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ label }),
        });
        if (!res.ok) throw new Error("request failed");
        unlabeledStatus.textContent = `Assigned ${folder} -> ${label}. Refresh to see changes.`;
      } catch (err) {
        unlabeledStatus.textContent = `Failed to assign ${folder}.`;
      } finally {
        form.querySelectorAll("button").forEach((btn) => (btn.disabled = false));
      }
    });
  });

  document.querySelectorAll(".delete-btn").forEach((button) => {
    button.addEventListener("click", async () => {
      const article = button.closest("article");
      const folder = article.dataset.folder;
      button.disabled = true;
      try {
        const res = await fetch(`/api/unlabeled/${folder}/delete`, { method: "POST" });
        if (!res.ok) throw new Error("request failed");
        unlabeledStatus.textContent = `Deleted ${folder}. Refresh to see changes.`;
      } catch (err) {
        unlabeledStatus.textContent = `Failed to delete ${folder}.`;
      } finally {
        button.disabled = false;
      }
    });
  });
</script>
{% endblock %}
